{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "_baseUrl": {
      "type": "string",
      "metadata": {
        "artifactsBaseUrl": "",
        "description": "URL to acquire other templates"
      },
      "defaultValue": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/sharepoint-three-vm"
    },
    "adDNSPrefix": {
      "type": "string",
      "metadata": {
        "description": "The DNS Prefix for the AD DC Public IP Address"
      }
    },
    "adNicIPAddress": {
      "type": "string",
      "metadata": {
        "description": "The IP address of the new AD VM"
      },
      "defaultValue": "10.0.0.4"
    },
    "adUsePublicIP": {
      "type": "bool",
      "defaultValue": false
    },
    "adVMSize": {
      "type": "string",
      "metadata": {
        "description": "The size of the AD VM Created"
      },
      "defaultValue": "Standard_A2_V2"
    },
    "commonStorageAccountNamePrefix": {
      "type": "string",
      "metadata": {
        "description": "Name prefix of the new storage account created to store the VMs disks"
      }
    },
    "commonStorageAccountType": {
      "type": "string",
      "allowedValues": [
        "Premium_LRS",
        "Standard_LRS",
        "Standard_GRS"
      ],
      "metadata": {
        "description": "The type of the Storage Account created"
      },
      "defaultValue": "Premium_LRS"
    },
    "commonSubnet": {
      "type": "string",
      "metadata": {
        "description": "The address range of the common subnet created in the new VNET"
      },
      "defaultValue": "10.0.0.0/24"
    },
    "commonVirtualNetworkAddressRange": {
      "type": "string",
      "metadata": {
        "description": "The address range of the new VNET"
      },
      "defaultValue": "10.0.0.0/16"
    },
    "commonVirtualNetworkName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Virtual Network to Create"
      },
      "defaultValue": "spfarmVNET"
    },
    "domainName": {
      "type": "string",
      "metadata": {
        "description": "The FQDN of the AD Domain created "
      },
      "defaultValue": "contoso.local"
    },
    "spDefaultSiteName": {
      "type": "string",
      "metadata": {
        "description": "The Sharepoint Default Site Name"
      }
    },
    "spDefaultSiteTemplateName": {
      "type": "string",
      "metadata": {
        "description": "The Sharepoint Content Site Template Name"
      },
      "defaultValue": "STS#0"
    },
    "spDNSPrefix": {
      "type": "string",
      "metadata": {
        "description": "The DNS Prefix for the SharePoint Public IP Address"
      }
    },
    "spFarmName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Sharepoint farm"
      },
      "defaultValue": "spfarm"
    },
    "spFarmPassphrase": {
      "type": "securestring",
      "metadata": {
        "description": "The Sharepoint Farm Passphrase"
      }
    },
    "spVMSize": {
      "type": "string",
      "metadata": {
        "description": "The size of the VM Created"
      },
      "defaultValue": "Standard_DS3"
    },
    "sqlVMSize": {
      "type": "string",
      "metadata": {
        "description": "The size of the SQL VM Created"
      },
      "defaultValue": "Standard_DS2"
    },
    "userAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "The name of the Administrator of the new VM and Domain"
      }
    },
    "userAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The password forthe Administrator account of the new VM and Domain"
      }
    },
    "userSPFarmUserName": {
      "type": "string",
      "metadata": {
        "description": "The Sharepoint Farm account name"
      },
      "defaultValue": "sp_farm"
    },
    "userSPFarmPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The Sharepoint Farm account password"
      }
    },
    "userSPSetupName": {
      "type": "string",
      "metadata": {
        "description": "The Sharepoint Setup account name"
      },
      "defaultValue": "sp_setup"
    },
    "userSPSetupPassword": {
      "type": "securestring",
      "metadata": {
        "description": "The Sharepoint Setup account password"
      }
    },
    "userSQLServiceUserName": {
      "type": "string",
      "metadata": {
        "description": "The SQL Server Service account name"
      },
      "defaultValue": "sqlservice"
    },
    "userSQLServicePassword": {
      "type": "securestring",
      "metadata": {
        "description": "The SQL Server Service account password"
      }
    }
  },
  "variables": {
    "_assetLocation": "[concat(parameters('_baseUrl'),'/dsc')]",
    "adAvailabilitySetName": "[concat(parameters('spFarmName'),'-ad-as')]",
    "adConfigurationFunction": "CreateADPDC.ps1\\CreateADPDC",
    "adModulesURL": "[concat(variables('_assetLocation'),'/CreateADPDC.ps1.zip')]",
    "adNicName": "[concat(parameters('spFarmName'), '-ad-vm1-nic')]",
    "adPublicIPAddressName": "[concat(parameters('spFarmName'), '-ad-vm1-pip')]",
    "adPublicIpResourceId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('adPublicIPAddressName'))]",
    "adVMName": "[concat(parameters('spFarmName'),'-ad-vm1')]",
    "commonNetworkSecurityGroupId": "[toLower(resourceId('Microsoft.Network/networkSecurityGroups', variables('commonNetworkSecurityGroupName')))]",
    "commonNetworkSecurityGroupName": "[concat(parameters('spFarmName'), '-common-nsg')]",
    "commonStorageAccountName": "[concat(parameters('commonStorageAccountNamePrefix'), '01')]",
    "commonSubnetName": "common",
    "commonSubnetRef": "[concat(variables('commonVNetID'),'/subnets/',variables('commonSubnetName'))]",
    "commonVNetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('commonVirtualNetworkName'))]",
    "dbAdminContentName": "SP_AdminContent",
    "dbConfigName": "SP_Config",
    "dbContentName": "WSS_Content_80",
    "urlCreatingAvailabilitySet": "[concat(parameters('_baseUrl'),'/creatingAvailabilitySet.json')]",
    "urlCreatingNetworkSecurityGroup": "[concat(parameters('_baseUrl'),'/creatingNetworkSecurityGroup.json')]",
    "urlCreatingNIC": "[concat(parameters('_baseUrl'),'/creatingNIC.json')]",
    "urlCreatingPublicIP": "[concat(parameters('_baseUrl'),'/creatingPublicIP.json')]",
    "urlCreatingSection": "[concat(parameters('_baseUrl'),'/creatingSection.json')]",
    "urlCreatingStorageAccount": "[concat(parameters('_baseUrl'),'/creatingStorageAccount.json')]",
    "urlCreatingVNet": "[concat(parameters('_baseUrl'),'/creatingVNet.json')]",
    "urlProvisioningDomainController": "[concat(parameters('_baseUrl'),'/provisioningDomainController.json')]",
    "urlUpdatingNICPublicIP": "[concat(parameters('_baseUrl'),'/updatingNICPublicIP.json')]"
  },
  "resources": [
    {
      "name": "CreatingStorageAccount-Common",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('urlCreatingStorageAccount')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "storageAccountType": {
            "value": "[parameters('commonStorageAccountType')]"
          },
          "storageAccountName": {
            "value": "[variables('commonStorageAccountName')]"
          }
        }
      }
    },
    {
      "name": "CreatingPublicIP-AD",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('urlCreatingPublicIP')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "dnsPrefix": {
            "value": "[parameters('adDNSPrefix')]"
          },
          "publicIPAddressName": {
            "value": "[variables('adPublicIPAddressName')]"
          },
          "publicIPAddressType": {
            "value": "Dynamic"
          }
        }
      }
    },
    {
      "name": "CreatingNetworkSecurityGroup-AD",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('urlCreatingNetworkSecurityGroup')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "nsgName": {
            "value": "[variables('commonNetworkSecurityGroupName')]"
          },
          "securityRules": {
            "value": [
              {
                "name": "allow-rdp",
                "properties": {
                  "description": "Allow inbound RDP",
                  "protocol": "Tcp",
                  "sourcePortRange": "*",
                  "destinationPortRange": "3389",
                  "sourceAddressPrefix": "*",
                  "destinationAddressPrefix": "*",
                  "access": "Allow",
                  "priority": 101,
                  "direction": "Inbound"
                }
              }
            ]
          }
        }
      }
    },
    {
      "name": "CreatingAvailabilitySet-AD",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('urlCreatingAvailabilitySet')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "availabilitySetName": {
            "value": "[variables('adAvailabilitySetName')]"
          }
        }
      }
    },
    {
      "name": "CreatingVirtualNetwork-Common",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/CreatingNetworkSecurityGroup-AD"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('urlCreatingVNet')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "virtualNetworkName": {
            "value": "[parameters('commonVirtualNetworkName')]"
          },
          "virtualNetworkAddressRange": {
            "value": "[parameters('commonVirtualNetworkAddressRange')]"
          },
          "subnets": {
            "value": [
              {
                "name": "[variables('commonSubnetName')]",
                "properties": {
                  "addressPrefix": "[parameters('commonSubnet')]",
                  "networkSecurityGroup": {
                    "id": "[variables('commonNetworkSecurityGroupId')]"
                  }
                }
              }
            ]
          }
        }
      }
    },
    {
      "name": "CreatingNetworkInterface-AD",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/CreatingPublicIP-AD",
        "Microsoft.Resources/deployments/CreatingVirtualNetwork-Common"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('urlCreatingNIC')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "nicName": {
            "value": "[variables('adNicName')]"
          },
          "nicIPAddress": {
            "value": "[parameters('adNicIPAddress')]"
          },
          "subnetRef": {
            "value": "[variables('commonSubnetRef')]"
          }
        }
      }
    },
    {
      "name": "UpdatingNICPublicIP-AD",
      "condition": "[parameters('adUsePublicIP')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/CreatingPublicIP-AD",
        "Microsoft.Resources/deployments/CreatingNetworkInterface-AD"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('urlUpdatingNICPublicIP')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "nicName": {
            "value": "[variables('adNicName')]"
          },
          "nicIPAddress": {
            "value": "[parameters('adNicIPAddress')]"
          },
          "subnetRef": {
            "value": "[variables('commonSubnetRef')]"
          },
          "publicIPId": {
            "value": "[variables('adPublicIpResourceId')]"
          }
        }
      }
    },
    {
      "name": "CreatingSection-2013",
      "comments": "Deploy the SharePoint 2013 farm with SQL Server",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/CreatingStorageAccount-Common",
        "Microsoft.Resources/deployments/CreatingVirtualNetwork-Common"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('urlCreatingSection')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "spVersion": {
            "value": "2013"
          },
          "sqlVersion": {
            "value": "SQL2014SP2-WS2012R2"
          },
          "subnetRange": {
            "value": "[concat('10.0.1.0/24')]"
          },
          "adminUserName": {
            "value": "[parameters('userAdminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('userAdminPassword')]"
          },
          "sqlVMSize": {
            "value": "[parameters('sqlVMSize')]"
          },
          "spVMSize": {
            "value": "[parameters('spVMSize')]"
          },
          "spDNSPrefix": {
            "value": "[parameters('spDNSPrefix')]"
          },
          "domainName": {
            "value": "[parameters('domainName')]"
          },
          "sqlServerServiceAccountUserName": {
            "value": "[parameters('userSQLServiceUserName')]"
          },
          "sqlServerServiceAccountPassword": {
            "value": "[parameters('userSQLServicePassword')]"
          },
          "sharePointSetupUserAccountUserName": {
            "value": "[parameters('userSPSetupName')]"
          },
          "sharePointSetupUserAccountPassword": {
            "value": "[parameters('userSPSetupPassword')]"
          },
          "sharePointFarmAccountUserName": {
            "value": "[parameters('userSPFarmUserName')]"
          },
          "sharePointFarmAccountPassword": {
            "value": "[parameters('userSPFarmPassword')]"
          },
          "sharePointFarmPassphrasePassword": {
            "value": "[parameters('spFarmPassphrase')]"
          },
          "defaultSiteName": {
            "value": "[parameters('spDefaultSiteName')]"
          },
          "defaultSiteTemplateName": {
            "value": "[parameters('spDefaultSiteTemplateName')]"
          },
          "defaultSiteConfigDatabaseName": {
            "value": "[variables('dbContentName')]"
          },
          "adminContentDatabaseName": {
            "value": "[variables('dbAdminContentName')]"
          },
          "configDatabaseName": {
            "value": "[variables('dbConfigName')]"
          },
          "storageAccountName": {
            "value": "[variables('commonStorageAccountName')]"
          }
        }
      }
    },
    {
      "name": "ProvisioningDomainController",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "Microsoft.Resources/deployments/CreatingStorageAccount-Common",
        "Microsoft.Resources/deployments/CreatingAvailabilitySet-AD",
        "Microsoft.Resources/deployments/CreatingNetworkInterface-AD"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('urlProvisioningDomainController')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "adVMName": {
            "value": "[variables('adVMName')]"
          },
          "adVMSize": {
            "value": "[parameters('adVMSize')]"
          },
          "adAvailabilitySetName": {
            "value": "[variables('adAvailabilitySetName')]"
          },
          "adminUsername": {
            "value": "[parameters('userAdminUsername')]"
          },
          "adminPassword": {
            "value": "[parameters('userAdminPassword')]"
          },
          "storageAccountName": {
            "value": "[variables('commonStorageAccountName')]"
          },
          "adNicName": {
            "value": "[variables('adNicName')]"
          },
          "adModulesURL": {
            "value": "[variables('adModulesURL')]"
          },
          "adConfigurationFunction": {
            "value": "[variables('adConfigurationFunction')]"
          },
          "domainName": {
            "value": "[parameters('domainName')]"
          }
        }
      }
    }
  ],
  "outputs": {}
}
