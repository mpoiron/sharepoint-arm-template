{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "outputs": {},
  "parameters": {
    "adNicAddress": {
      "type": "string"
    },
    "dbAdminContentName": {
      "type": "string"
    },
    "dbConfigName": {
      "type": "string"
    },
    "dbDefaultSiteConfigName": {
      "type": "string"
    },
    "domainName": {
      "type": "string"
    },
    "spDefaultSiteName": {
      "type": "string"
    },
    "spDefaultSiteTemplateName": {
      "type": "string",
      "defaultValue": "STS#0"
    },
    "spDNSPrefix": {
      "type": "string"
    },
    "spFarmNamePrefix": {
      "type": "string"
    },
    "spFarmPassphrase": {
      "type": "securestring"
    },
    "spNicIpAddress": {
      "type": "string"
    },
    "spUsePublicIP": {
      "type": "bool"
    },
    "spVersion": {
      "type": "string",
      "allowedValues": [
        "2013",
        "2016"
      ]
    },
    "spVMSize": {
      "type": "string"
    },
    "sqlDNSPrefix": {
      "type": "string"
    },
    "sqlNicIpAddress": {
      "type": "string"
    },
    "sqlUsePublicIP": {
      "type": "bool"
    },
    "sqlVersion": {
      "type": "string",
      "allowedValues": [
        "SQL2014SP2-WS2012R2",
        "SQL2016SP1-WS2016"
      ]
    },
    "sqlVMSize": {
      "type": "string"
    },
    "storageAccountName": {
      "type": "string"
    },
    "subnetAddressRange": {
      "type": "string"
    },
    "urlCreatingAvailabilitySet": {
      "type": "string"
    },
    "urlCreatingNetworkInterface": {
      "type": "string"
    },
    "urlCreatingNetworkSecurityGroup": {
      "type": "string"
    },
    "urlCreatingPublicIP": {
      "type": "string"
    },
    "urlProvisioningSQLServer": {
      "type": "string"
    },
    "urlUpdatingNICPublicIP": {
      "type": "string"
    },
    "userAdminPassword": {
      "type": "securestring"
    },
    "userAdminUsername": {
      "type": "string"
    },
    "userSPFarmPassword": {
      "type": "securestring"
    },
    "userSPFarmUsername": {
      "type": "string",
      "defaultValue": "sp_farm"
    },
    "userSPSetupPassword": {
      "type": "securestring"
    },
    "userSPSetupUsername": {
      "type": "string",
      "defaultValue": "sp_setup"
    },
    "userSQLServicePassword": {
      "type": "securestring"
    },
    "userSQLServiceUsername": {
      "type": "string",
      "defaultValue": "sqlservice"
    },
    "vNetName": {
      "type": "string"
    },
    "dscSQLPrepareModulesUrl": {
      "type": "string"
    },
    "dscSQLPrepareFunction": {
      "type": "string"
    }
  },
  "variables": {
    "_versionShortName": "[substring(parameters('spVersion'), 2, 2)]",
    "networkSecurityGroupName": "[concat(variables('spFarmName'), '-nsg')]",
    "networkSecurityGroupId": "[toLower(resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName')))]",    
    "spAvailabilitySetName": "[concat(variables('spFarmName'),'-sp1-as')]",
    "spFarmName": "[concat(parameters('spFarmNamePrefix'), variables('_versionShortName'))]",
    "spVMName": "[concat(variables('spFarmName'), '-sp1')]",
    "spNicName": "[concat(variables('spVmName'), '-nic')]",
    "spPublicIPAddressName": "[concat(variables('spVMName'), '-pip')]",
    "spPublicIpResourceId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('spPublicIPAddressName'))]",
    "sqlAvailabilitySetName": "[concat(variables('spFarmName'),'-sql1-as')]",    
    "sqlVMName": "[concat(variables('spFarmName'), '-sql1')]",
    "sqlNicName": "[concat(variables('sqlVmName'), '-nic')]",
    "sqlPublicIPAddressName": "[concat(variables('sqlVMName'), '-pip')]",
    "sqlPublicIpResourceId": "[resourceId('Microsoft.Network/publicIPAddresses', variables('sqlPublicIPAddressName'))]",
    "subnetRef": "[concat(variables('vNetID'),'/subnets/', parameters('spVersion'))]",
    "vNetID": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vNetName'))]"
  },
  "resources": [
    {
      "name": "[concat('CreatingPublicIP-SP', variables('_versionShortName'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[parameters('urlCreatingPublicIP')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "dnsPrefix": {
            "value": "[parameters('spDNSPrefix')]"
          },
          "publicIpAddressName": {
            "value": "[variables('spPublicIPAddressName')]"
          },
          "publicIPAddressType": {
            "value": "Dynamic"
          }
        }
      }
    },
    {
      "name": "[concat('CreatingPublicIP-SQL', variables('_versionShortName'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[parameters('urlCreatingPublicIP')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "dnsPrefix": {
            "value": "[parameters('sqlDNSPrefix')]"
          },
          "publicIpAddressName": {
            "value": "[variables('sqlPublicIPAddressName')]"
          },
          "publicIPAddressType": {
            "value": "Dynamic"
          }
        }
      }
    },
    {
      "name": "[concat('CreatingNetworkSecurityGroup-', variables('_versionShortName'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[parameters('urlCreatingNetworkSecurityGroup')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "nsgName": {
            "value": "[variables('networkSecurityGroupName')]"
          },
          "securityRules": {
            "value": [
              {
                "name": "allow-rdp",
                "properties": {
                  "description": "Allow inbound RDP",
                  "protocol": "Tcp",
                  "sourcePortRange": "*",
                  "destinationPortRange": "3389",
                  "sourceAddressPrefix": "*",
                  "destinationAddressPrefix": "*",
                  "access": "Allow",
                  "priority": 101,
                  "direction": "Inbound"
                }
              },
              {
                "name": "allow-centraladmin",
                "properties": {
                  "description": "Allow inbound traffic to SharePoint Central Admin",
                  "protocol": "Tcp",
                  "sourcePortRange": "*",
                  "destinationPortRange": "8000",
                  "sourceAddressPrefix": "*",
                  "destinationAddressPrefix": "[parameters('spNicIPAddress')]",
                  "access": "Allow",
                  "priority": 102,
                  "direction": "Inbound"
                }
              },
              {
                "name": "allow-webapps",
                "properties": {
                  "description": "Allow inbound traffic to web apps",
                  "protocol": "Tcp",
                  "sourcePortRange": "*",
                  "destinationPortRange": "80-90",
                  "sourceAddressPrefix": "*",
                  "destinationAddressPrefix": "[parameters('spNicIPAddress')]",
                  "access": "Allow",
                  "priority": 103,
                  "direction": "Inbound"
                }
              }
            ]
          }
        }
      }
    },
    {
      "name": "[concat(parameters('vNetName'), '/', parameters('spVersion'))]",
      "type": "Microsoft.Network/virtualNetworks/subnets",
      "apiVersion": "2017-06-01",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[concat('CreatingNetworkSecurityGroup-', variables('_versionShortName'))]"
      ],
      "properties": {
        "addressPrefix": "[parameters('subnetAddressRange')]",
        "networkSecurityGroup": {
          "id": "[variables('networkSecurityGroupId')]"
        }
      }
    },
    {
      "name": "[concat('CreatingNetworkInterface-SP', variables('_versionShortName'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[concat('Microsoft.Resources/deployments/CreatingPublicIP-SP', variables('_versionShortName'))]",
        "[variables('subnetRef')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[parameters('urlCreatingNetworkInterface')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "nicName": {
            "value": "[variables('spNicName')]"
          },
          "nicIPAddress": {
            "value": "[parameters('spNicIPAddress')]"
          },
          "subnetRef": {
            "value": "[variables('subnetRef')]"
          }
        }
      }
    },
    {
      "name": "[concat('CreatingNetworkInterface-SQL', variables('_versionShortName'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[concat('Microsoft.Resources/deployments/CreatingPublicIP-SQL', variables('_versionShortName'))]",
        "[variables('subnetRef')]"        
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[parameters('urlCreatingNetworkInterface')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "nicName": {
            "value": "[variables('sqlNicName')]"
          },
          "nicIPAddress": {
            "value": "[parameters('sqlNicIPAddress')]"
          },
          "subnetRef": {
            "value": "[variables('subnetRef')]"
          }
        }
      }
    },
    {
      "name": "UpdatingNetworkInterfacePublicIP-SP",
      "condition": "[parameters('spUsePublicIP')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[concat('CreatingPublicIP-SP', variables('_versionShortName'))]",
        "[concat('CreatingNetworkInterface-SP', variables('_versionShortName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[parameters('urlUpdatingNICPublicIP')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "nicName": {
            "value": "[variables('spNicName')]"
          },
          "nicIPAddress": {
            "value": "[parameters('spNicIPAddress')]"
          },
          "subnetRef": {
            "value": "[variables('subnetRef')]"
          },
          "publicIPId": {
            "value": "[variables('spPublicIpResourceId')]"
          }
        }
      }
    },
    {
      "name": "UpdatingNetworkInterfacePublicIP-SQL",
      "condition": "[parameters('sqlUsePublicIP')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[concat('CreatingPublicIP-SQL', variables('_versionShortName'))]",
        "[concat('CreatingNetworkInterface-SQL', variables('_versionShortName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[parameters('urlUpdatingNICPublicIP')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "nicName": {
            "value": "[variables('sqlNicName')]"
          },
          "nicIPAddress": {
            "value": "[parameters('sqlNicIPAddress')]"
          },
          "subnetRef": {
            "value": "[variables('subnetRef')]"
          },
          "publicIPId": {
            "value": "[variables('sqlPublicIpResourceId')]"
          }
        }
      }
    },
    {
      "name": "[concat('CreatingAvailabilitySet-SP', variables('_versionShortName'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[parameters('urlCreatingAvailabilitySet')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "availabilitySetName": {
            "value": "[variables('spAvailabilitySetName')]"
          }
        }
      }
    },
    {
      "name": "[concat('CreatingAvailabilitySet-SQL', variables('_versionShortName'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[parameters('urlCreatingAvailabilitySet')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "availabilitySetName": {
            "value": "[variables('sqlAvailabilitySetName')]"
          }
        }
      }
    },
    {
      "name": "ProvisioningSQLServerVM",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[concat('CreatingNetworkInterface-SQL', variables('_versionShortName'))]",
        "[concat('CreatingAvailabilitySet-SQL', variables('_versionShortName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[parameters('urlProvisioningSQLServer')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "vmName": {
            "value": "[variables('sqlVMName')]"
          },
          "vmSize": {
            "value": "[parameters('sqlVMSize')]"
          },
          "availabilitySetName": {
            "value": "[variables('sqlAvailabilitySetName')]"
          },
          "userAdminUsername": {
            "value": "[parameters('userAdminUsername')]"
          },
          "userAdminPassword": {
            "value": "[parameters('userAdminPassword')]"
          },
          "storageAccountName": {
            "value": "[parameters('storageAccountName')]"
          },
          "nicName": {
            "value": "[variables('sqlNicName')]"
          },
          "dscModulesUrl": {
            "value": "[parameters('dscSQLPrepareModulesUrl')]"
          },
          "dscFunction": {
            "value": "[parameters('dscSQLPrepareFunction')]"
          },
          "dnsServerAddress": {
            "value": "[parameters('adNicAddress')]"
          },
          "sqlVersion": {
            "value": "[parameters('sqlVersion')]"
          },
          "osDiskStorageType": {
            "value": "Standard_LRS"
          },
          "dataDiskStorageType": {
            "value": "Premium_LRS"
          }
        }
      }
    }
  ]
}